# PLANEJAMENTO T√âCNICO V1.1
**Sistema de Rastreamento Industrial - Vers√£o 1.1**

---

## 1. OBJETIVO T√âCNICO DA VERS√ÉO

Transformar o MVP (coleta pura) em ferramenta de **gest√£o ativa**, mantendo a simplicidade operacional intocada. 

**Meta central:** O operador continua registrando em < 10s, mas agora o sistema **alerta proativamente** quando ativos ficam ociosos e **orienta** o operador sobre o que fazer.

---

## 2. ESCOPO FECHADO V1.1

### 2.1 Alertas Simples por Data (5 dias)
- **Backend:** Query SQL que detecta ativos sem eventos h√° X dias
- **Frontend:** Admin configura intervalo de alerta por ativo
- **Notifica√ß√£o:** Email/WhatsApp 7 dias antes do vencimento
- **Regra de neg√≥cio:** Prazo configur√°vel (ex: "manuten√ß√£o a cada 90 dias")

### 2.2 Campo "Instru√ß√µes" (2 dias)
- **Backend:** Coluna `instructions` (TEXT) na tabela `assets`
- **Frontend:** Editor simples (3-5 bullet points) no painel admin
- **Exibi√ß√£o:** Ao escanear QR, operador v√™ instru√ß√µes antes de registrar
- **Valida√ß√£o:** M√°ximo 500 caracteres

### 2.3 Tipo "N√£o Conforme" (1 dia)
- **Backend:** Adicionar valor ao ENUM `event_type`
- **Valida√ß√£o:** Se tipo = "n√£o_conforme", foto √© obrigat√≥ria
- **Frontend:** Valida√ß√£o client-side + server-side
- **Mensagem de erro:** "Foto obrigat√≥ria para registrar n√£o conformidade"

### 2.4 Export CSV B√°sico (3 dias)
- **Backend:** Endpoint `/api/export/csv` com query filtrada por `asset_id`
- **Formato:** `asset_code, event_type, timestamp, operator, description, photo_url`
- **Limite inicial:** 10.000 linhas (prote√ß√£o de performance)
- **Frontend:** Bot√£o "Exportar CSV" no hist√≥rico do ativo

### 2.5 Campo "Marca/Modelo" (0.5 dia)
- **Backend:** Colunas `brand` (VARCHAR 100) e `model` (VARCHAR 100) em `assets`
- **Frontend:** Campos opcionais no cadastro do ativo
- **Indexa√ß√£o:** Sem √≠ndice inicial (baixo volume de consultas)

### 2.6 Tipo "Melhoria" (0.5 dia)
- **Backend:** Adicionar valor ao ENUM `event_type`
- **Frontend:** Nova op√ß√£o no dropdown de eventos
- **Sem valida√ß√µes extras:** Mesmo fluxo dos outros tipos

---

## 3. ARQUITETURA

### 3.1 Ajustes no Supabase

#### **Tabela `assets` (altera√ß√µes)**
```sql
ALTER TABLE assets
ADD COLUMN instructions TEXT,
ADD COLUMN brand VARCHAR(100),
ADD COLUMN model VARCHAR(100),
ADD COLUMN maintenance_interval_days INTEGER DEFAULT NULL,
ADD COLUMN last_maintenance_date TIMESTAMP DEFAULT NULL;

-- Coment√°rio: maintenance_interval_days = prazo entre manuten√ß√µes (90, 180 dias, etc)
-- Coment√°rio: last_maintenance_date = atualizado automaticamente por trigger
```

#### **Tabela `events` (altera√ß√µes)**
```sql
ALTER TYPE event_type ADD VALUE IF NOT EXISTS 'n√£o_conforme';
ALTER TYPE event_type ADD VALUE IF NOT EXISTS 'melhoria';

-- Valida√ß√£o de foto obrigat√≥ria (CHECK constraint)
ALTER TABLE events
ADD CONSTRAINT photo_required_for_nonconformity
CHECK (
  (event_type != 'n√£o_conforme') OR 
  (event_type = 'n√£o_conforme' AND photo_url IS NOT NULL)
);
```

#### **Fun√ß√£o para atualizar `last_maintenance_date`**
```sql
CREATE OR REPLACE FUNCTION update_last_maintenance_date()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.event_type = 'manuten√ß√£o' THEN
    UPDATE assets
    SET last_maintenance_date = NEW.created_at
    WHERE id = NEW.asset_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_maintenance_date
AFTER INSERT ON events
FOR EACH ROW
EXECUTE FUNCTION update_last_maintenance_date();
```

#### **View para detectar ativos ociosos**
```sql
CREATE OR REPLACE VIEW assets_needing_alert AS
SELECT 
  a.id,
  a.code,
  a.name,
  a.last_maintenance_date,
  a.maintenance_interval_days,
  (a.last_maintenance_date + (a.maintenance_interval_days || ' days')::INTERVAL) AS next_maintenance_due,
  (a.last_maintenance_date + (a.maintenance_interval_days - 7 || ' days')::INTERVAL) AS alert_date
FROM assets a
WHERE 
  a.maintenance_interval_days IS NOT NULL
  AND (a.last_maintenance_date + (a.maintenance_interval_days - 7 || ' days')::INTERVAL) <= NOW()
  AND (a.last_maintenance_date + (a.maintenance_interval_days || ' days')::INTERVAL) > NOW();
```

#### **√çndices de Performance**
```sql
-- Acelera consultas de hist√≥rico por ativo + data
CREATE INDEX idx_events_asset_date ON events(asset_id, created_at DESC);

-- Acelera detec√ß√£o de ativos ociosos
CREATE INDEX idx_assets_maintenance ON assets(last_maintenance_date, maintenance_interval_days)
WHERE maintenance_interval_days IS NOT NULL;
```

#### **Row Level Security (RLS) - Sem altera√ß√µes**
Manter pol√≠ticas atuais:
- `events`: INSERT p√∫blico via token, SELECT p√∫blico
- `assets`: SELECT p√∫blico, INSERT/UPDATE apenas admin

### 3.2 Pontos de Aten√ß√£o de Performance

| M√©trica | Limite Free Tier | Gatilho de Alerta | A√ß√£o |
|---------|------------------|-------------------|------|
| **Requisi√ß√µes/m√™s** | 500.000 | 400.000 (80%) | Monitorar dashboard Supabase diariamente |
| **Storage de fotos** | 1GB | 800MB (80%) | Implementar compress√£o client-side (pr√≥ximo sprint) |
| **Tamanho do banco** | 500MB | 400MB (80%) | Avaliar arquivamento de eventos antigos (>1 ano) |
| **Tempo de query** | N/A | >2s | Adicionar √≠ndices espec√≠ficos ou otimizar queries |

**Estrat√©gia de mitiga√ß√£o:**
- Implementar cache Redis (Upstash Free) se queries do dashboard ultrapassarem 1s
- Pagina√ß√£o cursor-based no hist√≥rico (50 eventos por p√°gina)
- Compress√£o de imagens no upload (reduzir 5MB para ~500KB com qualidade 80%)

### 3.3 Estrutura de Dados Final

#### **Schema Completo (p√≥s V1.1)**

```
TABELA: assets
‚îú‚îÄ‚îÄ id (UUID, PK)
‚îú‚îÄ‚îÄ code (VARCHAR, UNIQUE) ‚Üí QR Code
‚îú‚îÄ‚îÄ name (VARCHAR)
‚îú‚îÄ‚îÄ location (VARCHAR)
‚îú‚îÄ‚îÄ instructions (TEXT) ‚Üí NOVO V1.1
‚îú‚îÄ‚îÄ brand (VARCHAR) ‚Üí NOVO V1.1
‚îú‚îÄ‚îÄ model (VARCHAR) ‚Üí NOVO V1.1
‚îú‚îÄ‚îÄ maintenance_interval_days (INTEGER) ‚Üí NOVO V1.1
‚îú‚îÄ‚îÄ last_maintenance_date (TIMESTAMP) ‚Üí NOVO V1.1
‚îî‚îÄ‚îÄ created_at (TIMESTAMP)

TABELA: events
‚îú‚îÄ‚îÄ id (UUID, PK)
‚îú‚îÄ‚îÄ asset_id (UUID, FK ‚Üí assets.id)
‚îú‚îÄ‚îÄ event_type (ENUM: manuten√ß√£o, limpeza, inspe√ß√£o, n√£o_conforme, melhoria)
‚îú‚îÄ‚îÄ operator (VARCHAR, opcional)
‚îú‚îÄ‚îÄ description (VARCHAR 200, opcional)
‚îú‚îÄ‚îÄ photo_url (VARCHAR, obrigat√≥rio se event_type='n√£o_conforme')
‚îú‚îÄ‚îÄ created_at (TIMESTAMP, autom√°tico)
‚îî‚îÄ‚îÄ CONSTRAINT: photo_required_for_nonconformity
```

---

## 4. PLANO DE IMPLEMENTA√á√ÉO (12 DIAS √öTEIS)

### **BACKEND (6 dias)**

#### Dia 1-2: Estrutura de Alertas
1. Aplicar migrations SQL (tabelas, triggers, views)
2. Criar edge function `check-maintenance-alerts` (Supabase Functions)
3. Configurar Cron job (Supabase) para rodar diariamente √†s 08:00
4. Integrar Twilio API (WhatsApp) e Resend (Email)
5. Testar envio manual de alerta

**Entreg√°vel:** Script SQL + Edge Function funcional

#### Dia 3: Valida√ß√µes e Novos Tipos
1. Adicionar valores ao ENUM `event_type`
2. Implementar constraint de foto obrigat√≥ria
3. Criar endpoint `/api/events` com valida√ß√£o server-side
4. Testar casos de erro (foto faltando, tipo inv√°lido)

**Entreg√°vel:** Endpoint atualizado + testes manuais OK

#### Dia 4-5: Export CSV
1. Criar endpoint `/api/export/csv?asset_id=X`
2. Implementar query otimizada com √≠ndices
3. Adicionar header HTTP correto (`Content-Type: text/csv`)
4. Limitar a 10.000 linhas com mensagem de erro se exceder
5. Testar com datasets de 1.000, 5.000, 10.000 eventos

**Entreg√°vel:** Endpoint funcional + valida√ß√£o de performance

#### Dia 6: Campos Adicionais
1. Atualizar endpoint `/api/assets` para aceitar `instructions`, `brand`, `model`, `maintenance_interval_days`
2. Validar tamanho m√°ximo de `instructions` (500 chars)
3. Atualizar resposta do endpoint GET `/api/assets/:id` para incluir novos campos

**Entreg√°vel:** API completa para V1.1

---

### **FRONTEND (5 dias)**

#### Dia 1-2: Painel Admin - Configura√ß√£o de Alertas
1. Adicionar campos no formul√°rio de cadastro/edi√ß√£o de ativo:
   - `maintenance_interval_days` (n√∫mero, ex: 90)
   - `instructions` (textarea, 500 chars)
   - `brand` e `model` (text inputs)
2. Valida√ß√£o client-side (instru√ß√µes n√£o pode exceder 500 chars)
3. UI minimalista: manter design atual (dark mode, KISS)

**Entreg√°vel:** Formul√°rio atualizado + valida√ß√µes

#### Dia 3: Exibi√ß√£o de Instru√ß√µes para Operador
1. Ao escanear QR, buscar `assets/:id` e verificar se `instructions` existe
2. Se existe, mostrar card acima do formul√°rio de registro:
   ```
   üìã Instru√ß√µes para este ativo:
   ‚Ä¢ [Bullet 1]
   ‚Ä¢ [Bullet 2]
   ```
3. Card deve ser colaps√°vel (n√£o bloquear o registro)

**Entreg√°vel:** Fluxo operador atualizado

#### Dia 4: Dropdown de Eventos + Valida√ß√£o de Foto
1. Adicionar op√ß√µes "N√£o Conforme" e "Melhoria" no dropdown
2. Se usu√°rio selecionar "N√£o Conforme":
   - Campo de foto passa a ser obrigat√≥rio (disabled bot√£o "Salvar" se vazio)
   - Mensagem visual: "‚ö†Ô∏è Foto obrigat√≥ria para n√£o conformidades"
3. Valida√ß√£o antes de enviar request

**Entreg√°vel:** Dropdown + valida√ß√£o funcional

#### Dia 5: Bot√£o Export CSV
1. Adicionar bot√£o "Exportar CSV" no hist√≥rico do ativo (painel admin)
2. Ao clicar, fazer request para `/api/export/csv?asset_id=X`
3. Download autom√°tico do arquivo `historico_[asset_code]_[data].csv`
4. Mostrar loading spinner durante export

**Entreg√°vel:** Feature de export funcional

---

### **INFRA E DEVOPS (1 dia)**

#### Dia 1: Monitoramento e Deploy
1. Configurar Sentry para capturar erros de:
   - Falha no envio de alertas (Twilio/Resend)
   - Queries lentas (> 2s)
   - Uploads de foto que falham
2. Configurar Vercel Analytics para medir:
   - Tempo de carregamento da p√°gina de registro
   - Taxa de sucesso de uploads
3. Deploy em staging (Vercel Preview)
4. Testes de carga com 500 requests simult√¢neos (usar Artillery ou k6)
5. Deploy em produ√ß√£o com rollout 10% ‚Üí 30% ‚Üí 100%

**Entreg√°vel:** V1.1 em produ√ß√£o com monitoramento ativo

---

## 5. CHECKLIST DE QUALIDADE (GO-LIVE)

### **Crit√©rios de Bloqueio (P0/P1)**

- [ ] **Zero bugs P0:** Sistema inacess√≠vel, perda de dados, registro imposs√≠vel
- [ ] **M√°ximo 2 bugs P1** (com workaround documentado)
  - Exemplo P1: Export CSV falha para ativos com >5.000 eventos (workaround: filtrar por per√≠odo)

### **Valida√ß√µes T√©cnicas**

- [ ] Tempo de resposta `/api/events` < 1s (mediana de 100 requests)
- [ ] Upload de foto (5MB) completa em < 10s (3G simulado)
- [ ] Query da view `assets_needing_alert` executa em < 500ms
- [ ] Export CSV de 1.000 eventos completa em < 3s
- [ ] Constraint de foto obrigat√≥ria funciona (teste com request direto ao backend)
- [ ] Trigger de `last_maintenance_date` atualiza corretamente ap√≥s evento

### **Testes de Regress√£o**

- [ ] Fluxo V1.0 continua id√™ntico (operador n√£o nota mudan√ßas no registro)
- [ ] QR Code scanning ainda funciona em < 3s
- [ ] Hist√≥rico imut√°vel: eventos antigos n√£o foram alterados
- [ ] Todas as 6 telas originais continuam funcionando

### **Monitoramento Pr√©-Go-Live**

- [ ] Sentry configurado e recebendo eventos de teste
- [ ] Dashboard Supabase mostrando m√©tricas de uso
- [ ] Cron job de alertas rodando e logando execu√ß√µes
- [ ] Backup manual do banco de dados realizado

---

## 6. RISCOS T√âCNICOS E MITIGA√á√ÉO

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| **Alertas n√£o enviados (Twilio/Resend offline)** | M√©dia | Alto | Implementar retry com backoff exponencial (3 tentativas). Log em tabela `alert_failures` para auditoria. |
| **Query lenta na view `assets_needing_alert`** | Baixa | M√©dio | √çndice `idx_assets_maintenance` j√° criado. Se necess√°rio, cachear resultado por 1h. |
| **Export CSV trava com datasets grandes** | M√©dia | Baixo | Limite hard de 10.000 linhas. Documentar workaround (filtrar por per√≠odo). Implementar pagina√ß√£o no V1.2 se necess√°rio. |
| **Foto obrigat√≥ria gera reclama√ß√µes** | Alta | Baixo | Documentar l√≥gica claramente no onboarding. Se >10% dos clientes reclamarem, tornar opcional e adicionar apenas um warning. |
| **Free Tier Supabase estourado antes do esperado** | Baixa | Alto | Monitoramento di√°rio do dashboard. Preparar script de migra√ß√£o para Pro ($25/m√™s) com 1 clique. |
| **Constraint de foto quebra fluxo existente** | Baixa | Cr√≠tico | Aplicar constraint apenas para novos eventos (`created_at > data_deploy_v1.1`). Eventos antigos sem foto n√£o s√£o afetados. |

### **Protocolo de Rollback**

Se **Error Rate > 5%** ou **Query Time > 3s** nas primeiras 24h:

1. Reverter deployment no Vercel (1 clique)
2. Remover constraint de foto obrigat√≥ria via SQL
3. Desativar Cron job de alertas
4. Manter novos campos (`instructions`, `brand`, `model`) - n√£o causam problemas
5. Comunicar clientes beta via WhatsApp: "Pequeno ajuste t√©cnico, sistema volta ao normal"

---

## 7. ENTREGA FINAL PARA A EQUIPE

### **Documenta√ß√£o T√©cnica**

1. **SQL Migrations:** Arquivo `v1.1_migrations.sql` com todos os comandos (executar em staging primeiro)
2. **Endpoints Novos/Alterados:**
   - POST `/api/assets` ‚Üí Aceita novos campos
   - GET `/api/assets/:id` ‚Üí Retorna instru√ß√µes
   - POST `/api/events` ‚Üí Valida foto obrigat√≥ria
   - GET `/api/export/csv?asset_id=X` ‚Üí Novo endpoint
3. **Edge Function:** `check-maintenance-alerts` (c√≥digo TypeScript + configura√ß√£o Cron)
4. **Componentes React:**
   - `AssetForm.tsx` ‚Üí Atualizar com novos campos
   - `InstructionsCard.tsx` ‚Üí Novo componente colaps√°vel
   - `EventDropdown.tsx` ‚Üí Adicionar 2 op√ß√µes
   - `ExportButton.tsx` ‚Üí Novo componente

### **Checklist de Dev**

```markdown
## Backend
- [ ] Aplicar migrations em staging
- [ ] Testar triggers manualmente (inserir evento ‚Üí verificar last_maintenance_date)
- [ ] Criar edge function de alertas
- [ ] Configurar Cron job (di√°rio, 08:00 BRT)
- [ ] Integrar Twilio (WhatsApp) e Resend (Email)
- [ ] Criar endpoint /api/export/csv
- [ ] Adicionar valida√ß√£o server-side de foto obrigat√≥ria
- [ ] Testar performance com dataset de 10.000 eventos

## Frontend
- [ ] Atualizar AssetForm com 4 novos campos
- [ ] Criar InstructionsCard (colaps√°vel, acima do formul√°rio)
- [ ] Adicionar "N√£o Conforme" e "Melhoria" ao dropdown
- [ ] Implementar valida√ß√£o client-side de foto obrigat√≥ria
- [ ] Criar bot√£o Export CSV no hist√≥rico
- [ ] Testar fluxo completo em staging

## Infra
- [ ] Configurar Sentry (errors + performance)
- [ ] Configurar Vercel Analytics
- [ ] Realizar backup do banco de produ√ß√£o
- [ ] Deploy em staging
- [ ] Testes de carga (500 requests)
- [ ] Deploy gradual (10% ‚Üí 30% ‚Üí 100%)

## QA
- [ ] Validar todos os crit√©rios do Checklist de Go-Live
- [ ] Testar em 3 dispositivos m√≥veis (Android, iOS, diferentes tamanhos)
- [ ] Validar tempos de resposta (< 3s para todas as opera√ß√µes)
- [ ] Confirmar que fluxo V1.0 n√£o foi alterado
```

### **Estimativa Final**

- **Backend:** 6 dias
- **Frontend:** 5 dias
- **Infra/Deploy:** 1 dia
- **Total:** 12 dias √∫teis

**Condi√ß√£o para in√≠cio:** Dev dispon√≠vel para 40h nos pr√≥ximos 30 dias (conforme documento PM).

### **Defini√ß√£o de "Pronto"**

V1.1 est√° pronto quando:
1. Todos os itens do Checklist de QA est√£o ‚úÖ
2. Sistema passou 24h em produ√ß√£o com error rate < 2%
3. Pelo menos 1 alerta foi enviado e confirmado por cliente beta
4. Tempo de registro continua < 10s (validado com 3 operadores reais)

---

**Status:** Aguardando aprova√ß√£o para iniciar implementa√ß√£o.